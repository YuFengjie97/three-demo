import{_ as p,ae as x,u as B,af as M,a4 as H,ag as K,c as O,m as $,ah as G,V as F,ai as Q}from"./extends-D4P9RtWV.js";import{r as e}from"./chunk-EPOLDU6W-D-U-5P6E.js";const R=(a,r)=>{a.updateRanges[0]=r};function k(a){return typeof a=="function"}const C=new x,_=new x,h=[],y=new $;class q extends K{constructor(){super(),this.color=new O("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var r;return(r=this.instance.current)==null?void 0:r.geometry}raycast(r,u){const t=this.instance.current;if(!t||!t.geometry||!t.material)return;y.geometry=t.geometry;const l=t.matrixWorld,n=t.userData.instances.indexOf(this.instanceKey);if(!(n===-1||n>t.count)){t.getMatrixAt(n,C),_.multiplyMatrices(l,C),y.matrixWorld=_,t.material instanceof G?y.material.side=t.material.side:y.material.side=t.material[0].side,y.raycast(r,h);for(let m=0,f=h.length;m<f;m++){const i=h[m];i.instanceId=n,i.object=this,u.push(i)}h.length=0}}}const j=e.createContext(null),D=new x,U=new x,J=new x,W=new F,P=new Q,S=new F,N=a=>a.isInstancedBufferAttribute,z=e.forwardRef(({context:a,children:r,...u},t)=>{e.useMemo(()=>H({PositionMesh:q}),[]);const l=e.useRef(null);e.useImperativeHandle(t,()=>l.current,[]);const{subscribe:n,getParent:m}=e.useContext(a||j);return e.useLayoutEffect(()=>n(l),[]),e.createElement("positionMesh",p({instance:m(),instanceKey:l,ref:l},u),r)}),T=e.forwardRef(({context:a,children:r,range:u,limit:t=1e3,frames:l=1/0,...n},m)=>{const[{localContext:f,instance:i}]=e.useState(()=>{const c=e.createContext(null);return{localContext:c,instance:e.forwardRef((o,w)=>e.createElement(z,p({context:c},o,{ref:w})))}}),s=e.useRef(null);e.useImperativeHandle(m,()=>s.current,[]);const[d,b]=e.useState([]),[[I,E]]=e.useState(()=>{const c=new Float32Array(t*16);for(let o=0;o<t;o++)J.identity().toArray(c,o*16);return[c,new Float32Array([...new Array(t*3)].map(()=>1))]});e.useEffect(()=>{s.current.instanceMatrix.needsUpdate=!0});let v=0,g=0;const L=e.useRef([]);e.useLayoutEffect(()=>{L.current=Object.entries(s.current.geometry.attributes).filter(([c,o])=>N(o))}),B(()=>{if(l===1/0||v<l){s.current.updateMatrix(),s.current.updateMatrixWorld(),D.copy(s.current.matrixWorld).invert(),g=Math.min(t,u!==void 0?u:t,d.length),s.current.count=g,R(s.current.instanceMatrix,{start:0,count:g*16}),R(s.current.instanceColor,{start:0,count:g*3});for(let c=0;c<d.length;c++){const o=d[c].current;o.matrixWorld.decompose(W,P,S),U.compose(W,P,S).premultiply(D),U.toArray(I,c*16),s.current.instanceMatrix.needsUpdate=!0,o.color.toArray(E,c*3),s.current.instanceColor.needsUpdate=!0}v++}});const A=e.useMemo(()=>({getParent:()=>s,subscribe:c=>(b(o=>[...o,c]),()=>b(o=>o.filter(w=>w.current!==c.current)))}),[]);return e.createElement("instancedMesh",p({userData:{instances:d,limit:t,frames:l},matrixAutoUpdate:!1,ref:s,args:[null,null,0],raycast:()=>null},n),e.createElement("instancedBufferAttribute",{attach:"instanceMatrix",args:[I,16],usage:M}),e.createElement("instancedBufferAttribute",{attach:"instanceColor",args:[E,3],usage:M}),k(r)?e.createElement(f.Provider,{value:A},r(i)):a?e.createElement(a.Provider,{value:A},r):e.createElement(j.Provider,{value:A},r))});function Y(){const a=e.createContext(null);return[e.forwardRef((r,u)=>e.createElement(T,p({ref:u,context:a},r))),e.forwardRef((r,u)=>e.createElement(z,p({ref:u,context:a},r)))]}const Z=e.forwardRef(({name:a,defaultValue:r,normalized:u,usage:t=M},l)=>{const n=e.useRef(null);e.useImperativeHandle(l,()=>n.current,[]),e.useLayoutEffect(()=>{const f=n.current.__r3f.parent.object;f.geometry.attributes[a]=n.current;const i=Array.isArray(r)?r:[r],s=Array.from({length:f.userData.limit},()=>i).flat();return n.current.array=new Float32Array(s),n.current.itemSize=i.length,n.current.count=s.length/n.current.itemSize,()=>{delete f.geometry.attributes[a]}},[a]);let m=0;return B(()=>{const f=n.current.__r3f.parent.object;if(f.userData.frames===1/0||m<f.userData.frames){for(let i=0;i<f.userData.instances.length;i++){const d=f.userData.instances[i].current[a];d!==void 0&&(n.current.set(Array.isArray(d)?d:typeof d.toArray=="function"?d.toArray():[d],i*n.current.itemSize),n.current.needsUpdate=!0)}m++}}),e.createElement("instancedBufferAttribute",{ref:n,usage:t,normalized:u})});export{T as I,z as a,Z as b,Y as c};
